<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.kapture.admin.mapper.AdminMapper">
	
 <!-- üìÖ ÏõîÎ≥Ñ Îß§Ï∂ú -->
    <select id="getMonthChartByYear" parameterType="hashmap" resultType="map">
        SELECT 
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '01', AMOUNT)), 0) AS "01Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '02', AMOUNT)), 0) AS "02Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '03', AMOUNT)), 0) AS "03Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '04', AMOUNT)), 0) AS "04Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '05', AMOUNT)), 0) AS "05Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '06', AMOUNT)), 0) AS "06Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '07', AMOUNT)), 0) AS "07Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '08', AMOUNT)), 0) AS "08Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '09', AMOUNT)), 0) AS "09Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '10', AMOUNT)), 0) AS "10Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '11', AMOUNT)), 0) AS "11Ïõî",
            NVL(SUM(DECODE(TO_CHAR(PAYMENT_DATE, 'MM'), '12', AMOUNT)), 0) AS "12Ïõî"
        FROM PAYMENTS
        WHERE TO_CHAR(PAYMENT_DATE, 'YYYY') = #{year}
    </select>

    <!--  ÏßÄÏó≠ + ÌÖåÎßàÎ≥Ñ  -->
    <select id="getThemeSalesByRegion" resultType="hashmap">
    SELECT 
        SI_NAME AS REGION,           <!-- ‚úÖ Ïù¥ ÎùºÏù∏ Ï∂îÍ∞Ä! -->
        THEME_NAME AS THEME, 
        COUNT(*) AS TOTAL
    FROM PAYMENTS p
    JOIN TOURS t ON p.TOUR_NO = t.TOUR_NO
    JOIN THEME th ON t.THEME_NO = th.THEME_NO
    JOIN REGION r ON t.SI_NO = r.SI_NO
    WHERE 1=1
        <if test="year != null and year != ''">
            AND TO_CHAR(PAYMENT_DATE, 'YYYY') = #{year}
        </if>
        <if test="region != null and region != ''">
            AND SI_NAME = #{region}
        </if>
    GROUP BY SI_NAME, THEME_NAME   <!-- ‚úÖ Í∑∏Î£πÌïëÎèÑ SI_NAME Ìè¨Ìï® -->
    ORDER BY TOTAL DESC
</select>
	
	<select id="getRegionList" resultType="string">
	    SELECT DISTINCT SI_NAME
	    FROM REGION
	    WHERE SI_NAME IS NOT NULL
	    ORDER BY SI_NAME
	</select>
    
    <select id="getDayChartByYearMonth" parameterType="map" resultType="map">
    SELECT TO_CHAR(PAYMENT_DATE, 'DD') || 'Ïùº' AS DAY,
           SUM(AMOUNT) AS TOTAL
    FROM PAYMENTS
    WHERE TO_CHAR(PAYMENT_DATE, 'YYYY') = #{year}
      AND TO_CHAR(PAYMENT_DATE, 'MM') = #{month}
    GROUP BY TO_CHAR(PAYMENT_DATE, 'DD')
    ORDER BY DAY
	</select>
	
		<!-- Ï¥ù Í±∞Îûò Í∏àÏï° -->
	<select id="selectTotalAmount" resultType="int">
	    SELECT NVL(SUM(p.AMOUNT), 0)
	    FROM PAYMENTS p
	    INNER JOIN TOURS t ON p.TOUR_NO = t.TOUR_NO
	    WHERE p.PAYMENT_STATUS = 'PAID'
	</select>
	
	<!-- Ïñ¥Ï†ú Í±∞Îûò Í∏àÏï° -->
	<select id="selectYesterdayAmount" resultType="int">
	    SELECT NVL(SUM(p.AMOUNT), 0)
	    FROM PAYMENTS p
	    INNER JOIN TOURS t ON p.TOUR_NO = t.TOUR_NO
	    WHERE p.PAYMENT_STATUS = 'PAID'
	    AND TRUNC(p.PAYMENT_DATE) = TRUNC(SYSDATE - 1)
	</select>
	
	<!-- Ï¥ù Ïù¥Ïö© Ïù∏Ïõê -->
	<select id="selectTotalUsers" resultType="int">
	    SELECT NVL(SUM(p.NUM_PEOPLE), 0)
	    FROM PAYMENTS p
	    INNER JOIN TOURS t ON p.TOUR_NO = t.TOUR_NO
	    WHERE p.PAYMENT_STATUS = 'PAID'
	</select>
	
	<!-- ÏäπÏù∏Îêú Í±¥Ïàò -->
	<select id="selectApprovedCount" resultType="int">
	    SELECT COUNT(*)
	    FROM PAYMENTS p
	    INNER JOIN TOURS t ON p.TOUR_NO = t.TOUR_NO
	    WHERE p.PAYMENT_STATUS = 'PAID'
	</select>
	
	<!-- Ï∑®ÏÜåÎêú Í±¥Ïàò -->
	<select id="selectRejectedCount" resultType="int">
	    SELECT COUNT(*)
	    FROM PAYMENTS p
	    INNER JOIN TOURS t ON p.TOUR_NO = t.TOUR_NO
	    WHERE p.PAYMENT_STATUS = 'REFUNDED'
	</select>
	
	<select id="selectTransactionList" resultType="hashmap">
  SELECT * FROM (
    SELECT ROWNUM AS RNUM, DATA.* FROM (
      SELECT
          PAYMENT_DATE,
          USER_FIRSTNAME,
          TITLE,
          AMOUNT,
          PAYMENT_STATUS,
          NUM_PEOPLE
      FROM PAYMENTS p
      JOIN USERS u ON p.USER_NO = u.USER_NO
      JOIN TOURS t ON p.TOUR_NO = t.TOUR_NO
      WHERE 1 = 1
      <if test="startDate != null and startDate != ''">
          AND PAYMENT_DATE &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
      </if>
      <if test="endDate != null and endDate != ''">
          AND PAYMENT_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
      </if>
      <if test="status != null and status != ''">
          AND PAYMENT_STATUS = #{status}
      </if>
      <if test="keyword != null and keyword != ''">
          AND (
              USER_FIRSTNAME LIKE '%' || #{keyword} || '%'
              OR TITLE LIKE '%' || #{keyword} || '%'
          )
      </if>
      ORDER BY PAYMENT_DATE DESC
	    ) DATA
	    WHERE ROWNUM &lt;= #{page} * #{size}
	  )
	  WHERE RNUM &gt; (#{page} - 1) * #{size}
	</select>
	
	<!--ÌéòÏù¥Ïßï Ï≤òÎ¶¨ -->
	<select id="selectTransactionTotalCount" resultType="int">
	  SELECT COUNT(*)
	  FROM PAYMENTS p
	  JOIN USERS u ON p.USER_NO = u.USER_NO
	  JOIN TOURS t ON p.TOUR_NO = t.TOUR_NO
	  WHERE 1 = 1
	  <if test="startDate != null and startDate != ''">
	    AND PAYMENT_DATE &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
	  </if>
	  <if test="endDate != null and endDate != ''">
	    AND PAYMENT_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
	  </if>
	  <if test="status != null and status != ''">
	    AND PAYMENT_STATUS = #{status}
	  </if>
	  <if test="keyword != null and keyword != ''">
	    AND (
	      USER_FIRSTNAME LIKE '%' || #{keyword} || '%'
	      OR TITLE LIKE '%' || #{keyword} || '%'
	    )
	  </if>
	</select>

	
    <!-- Í∞ÄÏù¥Îìú Ï†ïÎ≥¥Ï°∞Ìöå -->
    <select id="selectguidesList" parameterType="map" resultType="com.example.kapture.mypage.model.Guide">
        SELECT *
        FROM USERS U
        INNER JOIN GUIDES G ON G.USER_NO = U.USER_NO
    </select>
	<update id="updateGuideInfo" parameterType="hashmap">
		UPDATE GUIDES
		SET 
		<if test="profileImage != null">
			PROFILE_IMAGE = #{profileImage},
		</if>
		<if test="language != null">
			LANGUAGE = #{language},
		</if>
		<if test="experience != null">
			EXPERIENCE = #{experience},
		</if>
			G_UPDATED_AT = SYSDATE
		WHERE GUIDE_NO = #{guideNo}
	</update>
	<update id="updateUserInfo" parameterType="hashmap">
		UPDATE USERS
		SET USER_FIRSTNAME = #{userFirstName},
			EMAIL = #{email},
		<if test="gender != null">
			GENDER = #{gender},
		</if>
		<if test="password != null and password !=''">
			PASSWORD = #{password},
		</if>
		<if test="address != null">
			ADDRESS = #{address},
		</if>
		<if test="phone != null">
			PHONE = #{phone},
		</if>
		<if test="birthday != null">
			BIRTHDAY = #{birthday},
		</if>
			U_UPDATED_AT = SYSDATE
		WHERE USER_NO = #{userNo}
	</update>

		
</mapper>