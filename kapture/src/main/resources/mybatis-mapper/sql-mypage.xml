<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.kapture.mypage.mapper.MyPageMapper">
	<select id="selectUser" parameterType="hashmap" resultType="com.example.kapture.login.model.Login">
		SELECT USER_NO, PASSWORD, EMAIL, PHONE, ROLE, TO_CHAR(BIRTHDAY, 'YYYY-MM-DD') AS BIRTHDAY, ADDRESS, GENDER, U_CREATED_AT, U_UPDATED_AT, USER_FIRSTNAME, USER_LASTNAME, SOCIAL_TYPE, ISFOREIGNER, PUSHYN
		FROM USERS
		WHERE USER_NO = #{sessionId}
	</select>
	
	<update id="userInfoUpdate" parameterType="hashmap">
		UPDATE USERS
	    SET PHONE = #{phone},
	    	PUSHYN = #{pushYN},
	    	GENDER = #{gender}
	    WHERE USER_NO = #{sessionId}
	</update>
	
	<select id="selectPayList" parameterType="hashmap" resultType="com.example.kapture.mypage.model.Payments">
		SELECT P.*, TITLE, DURATION, TOUR_DATE
		FROM PAYMENTS P
		INNER JOIN TOURS T ON P.TOUR_NO = T.TOUR_NO
		WHERE USER_NO = #{sessionId}
	</select>	
	
	<insert id="insertTour" parameterType="hashmap">
		INSERT INTO TOURS (TOUR_NO, GUIDE_NO, TITLE, DURATION, PRICE, DELETEYN, SI_NO, GU_NO)
		SELECT TOUR_SEQ.NEXTVAL, G.GUIDE_NO, #{title}, #{duration}, #{price}, 'N', R.SI_NO, R.GU_NO
		FROM GUIDES G
		JOIN REGION R ON R.SI_NAME = #{siName} AND R.GU_NAME = #{guName}
		WHERE G.USER_NO = #{sessionId}
	</insert>
  
	<select id="selectUserReviewsList" parameterType="hashmap" resultType="com.example.kapture.mypage.model.Payments">
		SELECT P.*, TITLE, DURATION, TOUR_DATE, U.USER_FIRSTNAME, U.USER_LASTNAME, R.*
		FROM PAYMENTS P
		INNER JOIN TOURS T ON P.TOUR_NO = T.TOUR_NO
		INNER JOIN USERS U ON P.USER_NO = U.USER_NO
        LEFT JOIN REVIEWS R ON R.TOUR_NO = T.TOUR_NO AND R.USER_NO = P.USER_NO
		WHERE P.USER_NO = #{sessionId}
        ORDER BY PAYMENT_NO
	</select>
	
	<select id="selectGuideSchedule" parameterType="hashmap" resultType="com.example.kapture.mypage.model.Guide">
		SELECT *
        FROM GUIDES G
          	INNER JOIN TOURS T ON G.GUIDE_NO = T.GUIDE_NO
        	INNER JOIN USERS U ON U.USER_NO = G.USER_NO
                WHERE G.USER_NO = #{sessionId}
	</select>
</mapper>




