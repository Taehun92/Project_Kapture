<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.kapture.board.mapper.RequestMapper">
	<select id="selectRequestList" parameterType="hashmap" resultType="com.example.kapture.board.model.Request">
		SELECT *
        FROM REQUESTS R
        INNER JOIN USERS U ON R.USER_NO = U.USER_NO
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (TITLE LIKE '%' || #{keyword} || '%' OR USER_FIRSTNAME LIKE '%' || #{keyword} || '%' OR USER_LASTNAME LIKE '%' || #{keyword} || '%')
        </if>
        ORDER BY REQUEST_NO DESC
        OFFSET #{offset} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	<select id="countRequestList" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM REQUESTS R
        INNER JOIN USERS U ON R.USER_NO = U.USER_NO
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (TITLE LIKE '%' || #{keyword} || '%' OR USER_FIRSTNAME LIKE '%' || #{keyword} || '%' OR USER_LASTNAME LIKE '%' || #{keyword} || '%')
        </if>
    </select>
	<select id="selectRequest" parameterType="hashmap" resultType="com.example.kapture.board.model.Request">
		SELECT *
		FROM REQUESTS R
		INNER JOIN USERS U ON R.USER_NO = U.USER_NO
		WHERE R.REQUEST_NO = #{requestNo}
	</select>
	<select id="selectRequestCommentList" parameterType="hashmap" resultType="com.example.kapture.board.model.Comment">
		SELECT *
		FROM REQUEST_COMMENTS C1
		LEFT JOIN REQUEST_COMMENTS C2 ON C1.COMMENT_NO = C2.PARENT_COMMENT_NO
		INNER JOIN REQUESTS R ON R.REQUEST_NO = C1.REQUEST_NO
		INNER JOIN USERS U ON C1.USER_NO = U.USER_NO
		WHERE C1.REQUEST_NO = #{requestNo}
	</select>
	<insert id="insertRequest" parameterType="hashmap">
		INSERT INTO REQUESTS
		VALUES(REQUEST_SEQ.NEXTVAL, #{userNo}, #{title}, #{region}, #{budget}, '0', SYSDATE, SYSDATE, #{contents},#{currency})
	</insert>
	<insert id="insertRequestComment" parameterType="hashmap">
		INSERT INTO REQUEST_COMMENTS
		VALUES(COMMENT_NO_SEQ.NEXTVAL, #{userId}, #{requestNo}, #{comments}, SYSDATE, SYSDATE, #{commentNo})
	</insert>
	<update id="updateRequestStatus" parameterType="hashmap">
		UPDATE REQUESTS
		SET STATUS = '1'
		WHERE REQUEST_NO = #{requestNo}
	</update>
	<update id="acceptRequestStatus">
		UPDATE REQUESTS
		SET STATUS = '2'
		WHERE REQUEST_NO = #{requestNo}
	</update>
	<update id="updateRequestComment" parameterType="hashmap">
		UPDATE REQUEST_COMMENTS
		SET MESSAGE = #{comments}, RQC_UPDATE_AT = SYSDATE
		WHERE COMMENT_NO = #{commentNo}
	</update>
	<delete id="deleteRequest" parameterType="hashmap">
		DELETE FROM REQUESTS
		WHERE REQUEST_NO = #{requestNo}
	</delete>
	<delete id="deleteRequestComment" parameterType="hashmap">
		DELETE FROM REQUEST_COMMENTS
		WHERE COMMENT_NO = #{commentNo}
	</delete>
</mapper>